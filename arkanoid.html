<!DOCTYPE html>
<html lang="es">
<head>
    <!-- ... (el head se mantiene igual) ... -->
</head>
<body>
    <!-- ... (el body se mantiene igual hasta el script) ... -->
    <script>
        // ... (las variables iniciales se mantienen igual hasta la función collisionDetection) ...

        // Detección de colisiones
        function collisionDetection(paddleY) {
            // Colisión con ladrillos
            for (let c = 0; c < brickColumnCount; c++) {
                for (let r = 0; r < brickRowCount; r++) {
                    const brick = bricks[c][r];
                    if (brick.status === 1) {
                        if (
                            ballX > brick.x &&
                            ballX < brick.x + brickWidth &&
                            ballY > brick.y &&
                            ballY < brick.y + brickHeight
                        ) {
                            ballSpeedY = -ballSpeedY;
                            brick.status = 0;
                            score += 10;
                            updateScore();
                            
                            let allBricksDestroyed = true;
                            for (let c = 0; c < brickColumnCount; c++) {
                                for (let r = 0; r < brickRowCount; r++) {
                                    if (bricks[c][r].status === 1) {
                                        allBricksDestroyed = false;
                                        break;
                                    }
                                }
                                if (!allBricksDestroyed) break;
                            }
                            
                            if (allBricksDestroyed) {
                                isLevelComplete = true;
                                gameStarted = false;
                            }
                        }
                    }
                }
            }

            // Colisión con la paleta (más precisa)
            if (ballY + ballRadius > paddleY && ballY - ballRadius < paddleY + paddleHeight) {
                if (ballX + ballRadius > paddleX && ballX - ballRadius < paddleX + paddleWidth) {
                    // Solo rebota si golpea la parte superior de la paleta
                    if (ballY + ballRadius >= paddleY && ballY - ballSpeedY - ballRadius <= paddleY) {
                        ballSpeedY = -Math.abs(ballSpeedY); // Asegura que siempre rebote hacia arriba
                        ballY = paddleY - ballRadius - 1; // Coloca la pelota justo encima de la paleta
                        
                        // Efecto visual
                        for (let i = 0; i < 5; i++) {
                            setTimeout(() => {
                                ctx.fillStyle = `rgba(255, ${200 + Math.random() * 55}, ${Math.random() * 100}, 0.7)`;
                                ctx.beginPath();
                                ctx.arc(
                                    ballX + (Math.random() * 10 - 5), 
                                    paddleY - 10, 
                                    Math.random() * 3 + 1, 
                                    0, 
                                    Math.PI * 2
                                );
                                ctx.fill();
                            }, i * 50);
                        }
                    }
                }
            }
        }

        // Bucle principal del juego (modificar la parte de detección de pérdida)
        function gameLoop() {
            if (isGameOver) {
                showGameOver();
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
                return;
            }
            
            if (isLevelComplete) {
                level++;
                updateScore();
                createBricks();
                ballX = canvas.width / 2;
                ballY = canvas.height - paddleOffsetFromBottom - paddleHeight - ballRadius - 5;
                ballSpeedX = 0;
                ballSpeedY = 0;
                paddleX = (canvas.width - paddleWidth) / 2;
                isLevelComplete = false;
                gameStarted = false;
                
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = "#FFF";
                ctx.font = "24px Arial";
                ctx.textAlign = "center";
                ctx.fillText(`Nivel ${level}`, canvas.width / 2, canvas.height / 2);
                setTimeout(() => {
                    animationFrameId = requestAnimationFrame(gameLoop);
                }, 1000);
                return;
            }
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawBricks();
            drawBall();
            const paddleY = drawPaddle();
            collisionDetection(paddleY);

            // Movimiento de la paleta
            if (rightPressed && paddleX < canvas.width - paddleWidth) {
                paddleX += 7;
                if (!gameStarted) {
                    gameStarted = true;
                    ballSpeedX = 4 + level;
                    ballSpeedY = -4 - level;
                }
            } else if (leftPressed && paddleX > 0) {
                paddleX -= 7;
                if (!gameStarted) {
                    gameStarted = true;
                    ballSpeedX = -4 - level;
                    ballSpeedY = -4 - level;
                }
            }

            if (gameStarted) {
                // Rebotes en los bordes
                if (ballX + ballSpeedX > canvas.width - ballRadius || ballX + ballSpeedX < ballRadius) {
                    ballSpeedX = -ballSpeedX;
                }
                
                if (ballY + ballSpeedY < ballRadius) {
                    ballSpeedY = -ballSpeedY;
                }
                
                // Pérdida de pelota (ahora más estricto)
                if (ballY + ballSpeedY > canvas.height + ballRadius) {
                    lives--;
                    updateScore();
                    
                    if (lives <= 0) {
                        isGameOver = true;
                    } else {
                        // Reiniciar el nivel actual en lugar de pasar al siguiente
                        ballX = canvas.width / 2;
                        ballY = canvas.height - paddleOffsetFromBottom - paddleHeight - ballRadius - 5;
                        ballSpeedX = 0;
                        ballSpeedY = 0;
                        paddleX = (canvas.width - paddleWidth) / 2;
                        gameStarted = false;
                        
                        // No se reinician los ladrillos, se mantiene el nivel actual
                    }
                }

                // Movimiento de la pelota
                ballX += ballSpeedX;
                ballY += ballSpeedY;
            }
            
            animationFrameId = requestAnimationFrame(gameLoop);
        }

        // ... (el resto del código se mantiene igual) ...
    </script>
</body>
</html>
