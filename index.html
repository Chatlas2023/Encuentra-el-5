<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Seguime - GPS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      height: 85vh;
      background-color: white;
      color: black;
    }
    #map {
      width: 100%;
      flex-grow: 1;
      border: 1px solid #ccc;
      border-radius: 8px;
      margin-bottom: 5px;
      position: relative;
    }
    #infoContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 10px;
    }
    #status, #distance {
      font-size: 14px;
      font-weight: bold;
      text-align: center;
      margin: 0;
    }
    .buttons {
      display: flex;
      justify-content: center;
      gap: 10px;
      flex-wrap: wrap;
      padding: 0 10px;
      margin-bottom: 10px;
    }
    button {
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      border: none;
      border-radius: 5px;
      background-color: #007bff;
      color: white;
      flex: 1;
      max-width: 150px;
    }
    #stopButton {
      background-color: #dc3545;
    }
    #stopButton:hover {
      background-color: #a71d2a;
    }
    #stopButton.continue {
      background-color: #28a745;
    }
    #stopButton.continue:hover {
      background-color: #218838;
    }
    #darkModeButton {
      background-color: #333;
    }
    #speedPanel {
      position: absolute;
      top: 10px;
      right: 10px;
      background: rgba(255,255,255,0.9);
      padding: 12px 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      z-index: 1000;
      min-width: 150px;
    }
    .speed-row {
      display: flex;
      align-items: baseline;
      margin: 5px 0;
      font-size: 16px;
    }
    .speed-value {
      font-size: 24px;
      font-weight: bold;
      margin: 0 8px;
    }
    #neighborhoodName {
      position: absolute;
      bottom: 15px;
      left: 10px;
      background-color: #e4e8d1;
      padding: 4px 12px;
      border-radius: 5px;
      font-size: 22px;
      font-weight: bold;
      color: black;
      z-index: 1000;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
      min-width: 200px;
      text-align: center;
    }
    .leaflet-container {
      transition: none !important;
    }
    body.dark-mode {
      background-color: #121212;
      color: #ffffff;
    }
    body.dark-mode #map {
      border-color: #333 !important;
      filter: invert(1) hue-rotate(180deg);
    }
    body.dark-mode .buttons button {
      background-color: #444 !important;
      color: #ffffff;
    }
    body.dark-mode #status,
    body.dark-mode #distance {
      color: #ffffff !important;
    }
    body.dark-mode #speedPanel {
      background: rgba(33, 33, 33, 0.9);
      color: white;
    }
    body.dark-mode .speed-value {
      color: white;
    }
    body.dark-mode #neighborhoodName {
      background-color: #333;
      color: white;
    }
    @media (max-width: 600px) {
      .speed-row {
        font-size: 14px;
      }
      .speed-value {
        font-size: 20px;
      }
    }
  </style>
</head>
<body>
  <div id="map">
    <div id="speedPanel">
      <div class="speed-row">
        <span>Velocidad:</span>
        <span class="speed-value" id="currentSpeed">0</span>
        <span>km/h</span>
      </div>
      <div class="speed-row">
        <span>Promedio:</span>
        <span class="speed-value" id="averageSpeed">0</span>
        <span>km/h</span>
      </div>
    </div>
    <div id="neighborhoodName">
      Barrio: Cargando...
    </div>
  </div>
  <div id="infoContainer">
    <div id="status">Obteniendo ubicaci칩n...</div>
    <div id="distance">Distancia total recorrida: 0 km</div>
  </div>
  <div class="buttons">
    <button id="clearButton">Limpiar historial</button>
    <button id="stopButton">Pausar captura</button>
    <button id="shareButton">Enviar ruta WApp</button>
    <button id="darkModeButton">Modo oscuro</button>
    <input type="text" id="routeName" placeholder="Nombre de la ruta">
    <button id="saveRouteButton">Guardar ruta</button>
  </div>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Variables globales
    let map;
    let polyline;
    let coordinates = [];
    let totalDistance = 0;
    const MAX_COORDINATES = 1000;
    const MIN_DISTANCE_METERS = 15;
    let watchId;
    let wakeLockSentinel = null;
    let isCapturing = true;
    let shouldAdjustZoom = true;
    let neighborhoodsLayer;
    let userMarker;
    let precisionCircle = null;
    let speedValues = [];
    let avgSpeed = 0;
    let lastPosition = null;
    const ZOOM_STABLE_THRESHOLD = 5;

    // Inicializar el mapa
    function initMap() {
      map = L.map('map', {
        zoomControl: false
      }).setView([-34.6037, -58.3816], 15); // Coordenadas iniciales de Buenos Aires
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '춸 OpenStreetMap contributors'
      }).addTo(map);
      
      polyline = L.polyline([], { color: 'blue', weight: 6 }).addTo(map);
      loadNeighborhoods();
    }

    // Cargar barrios
    function loadNeighborhoods() {
      updateNeighborhoodName("Cargando mapa de barrios...");
      
      fetch('https://raw.githubusercontent.com/Chatlas2023/Seguime/main/Barrios_AMBA.geojson')
        .then(response => {
          if (!response.ok) throw new Error('Error HTTP');
          return response.json();
        })
        .then(data => {
          if (!data.features) throw new Error('Formato GeoJSON inv치lido');
          
          neighborhoodsLayer = L.geoJSON(data, {
            style: { color: '#ff7800', weight: 1, opacity: 1, fillOpacity: 0.1 },
            onEachFeature: (feature, layer) => {
              if (!feature.properties.Name) {
                feature.properties.Name = "Sin nombre";
              }
              layer.on('click', (e) => {
                updateNeighborhoodName(feature.properties.Name);
              });
            }
          }).addTo(map);
          
          updateNeighborhoodName("Mapa listo");
        })
        .catch(error => {
          console.error('Error cargando barrios:', error);
          updateNeighborhoodName("Error cargando barrios");
          neighborhoodsLayer = L.geoJSON({type: "FeatureCollection", features: []}).addTo(map);
        });
    }

    // Actualizar nombre del barrio
    function updateNeighborhoodName(name) {
      const element = document.getElementById('neighborhoodName');
      if (element) {
        element.textContent = `Barrio: ${name}`;
      }
    }

    // Encontrar barrio
    function findNeighborhood(lat, lng) {
      if (!neighborhoodsLayer || isNaN(lat) || isNaN(lng)) {
        updateNeighborhoodName("Datos no disponibles");
        return;
      }

      const point = L.latLng(lat, lng);
      let found = false;

      neighborhoodsLayer.eachLayer(layer => {
        try {
          if (layer.getBounds().contains(point)) {
            updateNeighborhoodName(layer.feature.properties.Name || "Barrio sin nombre");
            found = true;
          }
        } catch (e) {
          console.error('Error verificando barrio:', e);
        }
      });

      if (!found) {
        updateNeighborhoodName("Fuera del 치rea mapeada");
      }
    }

    // Actualizar mapa
    function updateMap(lat, lng) {
      if (!map || !polyline) return;
      
      const newLatLng = L.latLng(lat, lng);
      if (!isNaN(newLatLng.lat) && !isNaN(newLatLng.lng)) {
        polyline.addLatLng(newLatLng);
        const currentZoom = map.getZoom();
        map.setView(newLatLng, currentZoom || 16);
      }
    }

    // Obtener ubicaci칩n
    function getLocation() {
      if (navigator.geolocation) {
        updateStatus("Buscando se침al GPS...");
        acquireWakeLock();
        watchId = navigator.geolocation.watchPosition(
          (position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const speed = position.coords.speed;
            const accuracy = position.coords.accuracy;

            updateStatus(`Ubicaci칩n obtenida (Precisi칩n: ${Math.round(accuracy)} m)`);
            addCoordinate(lat, lng);
            updateMap(lat, lng);
            updateSpeed(speed);
            findNeighborhood(lat, lng);

            if (!userMarker) {
              userMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                  html: '游늸',
                  iconSize: [30, 30],
                  className: 'my-div-icon'
                })
              }).addTo(map);
            } else {
              userMarker.setLatLng([lat, lng]);
            }

            if (precisionCircle) {
              precisionCircle.setLatLng([lat, lng]).setRadius(accuracy);
            } else {
              precisionCircle = L.circle([lat, lng], {
                color: 'cyan',
                weight: 2,
                opacity: 1,
                fillColor: 'cyan',
                fillOpacity: 0.1,
                radius: accuracy
              }).addTo(map);
            }
          },
          (error) => {
            let errorMsg = "Error en GPS: ";
            switch(error.code) {
              case error.PERMISSION_DENIED:
                errorMsg += "Permiso denegado";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMsg += "Se침al no disponible";
                break;
              case error.TIMEOUT:
                errorMsg += "Tiempo de espera agotado";
                break;
              default:
                errorMsg += "Error desconocido";
            }
            updateStatus(errorMsg);
          },
          { 
            enableHighAccuracy: true, 
            maximumAge: 10000, 
            timeout: 15000 
          }
        );
      } else {
        updateStatus("Tu navegador no soporta geolocalizaci칩n");
      }
    }

    // Actualizar velocidad
    function updateSpeed(speed) {
      const speedKmh = speed ? speed * 3.6 : 0;
      
      if (speedKmh > 0) {
        speedValues.push(speedKmh);
        if (speedValues.length > 100) speedValues.shift();
      }
      
      const avg = speedValues.length > 0 ? 
        Math.round(speedValues.reduce((a, b) => a + b, 0) / speedValues.length) : 0;
      
      document.getElementById('currentSpeed').textContent = Math.round(speedKmh);
      document.getElementById('averageSpeed').textContent = avg;
    }

    // Resto de funciones (toggleCapture, toggleDarkMode, etc.) permanecen igual
    // ... [El resto del c칩digo JavaScript permanece igual] ...

    // Inicializaci칩n
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      getLocation();
      
      document.getElementById('darkModeButton').addEventListener('click', function() {
        document.body.classList.toggle('dark-mode');
        this.textContent = document.body.classList.contains('dark-mode') ? 'Modo claro' : 'Modo oscuro';
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode'));
      });

      if (localStorage.getItem('darkMode') === 'true') {
        document.body.classList.add('dark-mode');
        document.getElementById('darkModeButton').textContent = 'Modo claro';
      }
    });
  </script>
</body>
</html>
